name: Sync prod to Public Repo

on:
  push:
    branches:
      - prod

jobs:
  sync-to-public:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout prod branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: prod

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Verificar token
        env:
          PUBLIC_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          if [ -z "$PUBLIC_TOKEN" ]; then
            echo "::error::PUBLIC_REPO_TOKEN n√£o est√° configurado"
            exit 1
          fi
          
          # Testa se o token tem permiss√£o
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${PUBLIC_TOKEN}" \
            https://api.github.com/repos/marcosffp/hortifruti)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Token v√°lido e com permiss√£o"
          else
            echo "::error::Token sem permiss√£o (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Sincronizar prod ‚Üí prod (reposit√≥rio p√∫blico)
        env:
          PUBLIC_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          # Adiciona remote com token
          git remote add public https://${PUBLIC_TOKEN}@github.com/marcosffp/hortifruti.git
          
          # Sincroniza prod ‚Üí prod
          echo "üì§ Sincronizando branch prod para o reposit√≥rio p√∫blico..."
          git push public prod:prod --force
          
          echo "‚úÖ Sincroniza√ß√£o conclu√≠da! Branch prod ‚Üí prod"