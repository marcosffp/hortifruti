name: Sync prod to Public Repo

# Dispara apenas em pushes na branch prod
on:
  push:
    branches:
      - prod

permissions:
  contents: read

jobs:
  sync-to-public:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositório privado
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necessário para histórico completo
          ref: prod       # Garante que estamos na branch prod

      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Adicionar remote público
        env:
          PUBLIC_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          PUBLIC_URL="https://x-access-token:${PUBLIC_TOKEN}@github.com/marcosffp/hortifruti.git"
          git remote add public "${PUBLIC_URL}"
          git fetch public

      - name: Identificar branch padrão do repositório público
        id: get-default-branch
        env:
          PUBLIC_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          # Busca a branch padrão via API do GitHub
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${PUBLIC_TOKEN}" \
            https://api.github.com/repos/marcosffp/hortifruti | \
            jq -r '.default_branch')
          echo "default_branch=${DEFAULT_BRANCH}" >> $GITHUB_OUTPUT
          echo "Branch padrão detectada: ${DEFAULT_BRANCH}"

      - name: Sincronizar prod → branch padrão pública
        env:
          DEFAULT_BRANCH: ${{ steps.get-default-branch.outputs.default_branch }}
        run: |
          echo "Sincronizando prod → ${DEFAULT_BRANCH}"
          
          # Push da branch prod para a branch padrão do público
          git push public prod:${DEFAULT_BRANCH} --force-with-lease
          
          echo "✅ Sincronização concluída com sucesso!"

      - name: Notificar sucesso
        if: success()
        run: |
          echo "::notice::Branch prod sincronizada com sucesso para o repositório público"

      - name: Notificar falha
        if: failure()
        run: |
          echo "::error::Falha ao sincronizar. Verifique os logs acima."