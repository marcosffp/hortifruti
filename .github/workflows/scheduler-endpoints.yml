name: Execute Scheduler Endpoints

on:
  push:
    branches:
      - raiway
  schedule:
    - cron: '0 0 */3 * *'   # check-overdue a cada 3 dias
    - cron: '0 0 * * *'     # check-database-storage diariamente
  workflow_dispatch:

jobs:
  wake-up-application:
    runs-on: ubuntu-latest
    steps:
      - name: Wake up application
        id: wake_up
        run: |
          echo "üîî Tentando acordar a aplica√ß√£o..."
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.API_BASE_URL }}/scheduler/health" \
              -H "Authorization: Bearer ${{ secrets.API_TOKEN }}")
            if [ "$response" -eq 200 ]; then
              echo "‚úÖ Aplica√ß√£o est√° ativa!"
              exit 0
            fi
            echo "‚è≥ Aplica√ß√£o ainda n√£o est√° ativa. Tentativa $i/10. Aguardando 15 segundos..."
            sleep 15
          done
          echo "‚ùå N√£o foi poss√≠vel acordar a aplica√ß√£o ap√≥s 10 tentativas."
          exit 1

  call-scheduler-endpoints:
    runs-on: ubuntu-latest
    needs: wake-up-application
    steps:
      - name: Call "check-overdue" endpoint
        if: ${{ github.event_name == 'workflow_dispatch' || github.event.schedule == '0 0 */3 * *' }}
        run: |
          echo "üîÑ Chamando endpoint 'check-overdue'..."
          curl -X POST "${{ secrets.API_BASE_URL }}/scheduler/check-overdue" \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --max-time 120 \
          --retry 2
          echo "‚úÖ Check-overdue conclu√≠do!"

      - name: Call "check-database-storage" endpoint
        if: ${{ github.event_name == 'workflow_dispatch' || github.event.schedule == '0 0 * * *' }}
        run: |
          echo "üîÑ Chamando endpoint 'check-database-storage'..."
          curl -X POST "${{ secrets.API_BASE_URL }}/scheduler/check-database-storage" \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --max-time 120 \
          --retry 2
          echo "‚úÖ Check-database-storage conclu√≠do!"