name: Execute Scheduler Endpoints

on:
  schedule:
    - cron: '0 0 */3 * *' # check-overdue a cada 3 dias
    - cron: '0 0 * * *'   # check-database-storage diariamente
  workflow_dispatch:

jobs:
  wake-up-application:
    runs-on: ubuntu-latest
    steps:
      - name: Wake up application once
        run: |
          echo "üîî Acordando aplica√ß√£o..."
          # Tenta acordar com qualquer endpoint
          curl -X POST "${{ secrets.API_BASE_URL }}/api/scheduler/check-database-storage" \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --max-time 10 \
          --retry 0 || true
          
          echo "‚è≥ Aguardando 60 segundos para aplica√ß√£o inicializar..."
          sleep 60

  call-scheduler-endpoints:
    runs-on: ubuntu-latest
    needs: wake-up-application
    
    steps:
      - name: Call "check-overdue" endpoint
        if: github.event.schedule == '0 0 */3 * *' || github.event_name == 'workflow_dispatch'
        run: |
          curl -X POST "${{ secrets.API_BASE_URL }}/scheduler/check-overdue" \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --max-time 120 \
          --retry 2
          echo "‚úÖ Check-overdue conclu√≠do!"

      - name: Call "check-database-storage" endpoint
        if: github.event.schedule == '0 0 * * *' || github.event_name == 'workflow_dispatch'
        run: |
          curl -X POST "${{ secrets.API_BASE_URL }}/scheduler/check-database-storage" \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --max-time 120 \
          --retry 2
          echo "‚úÖ Check-database-storage conclu√≠do!"